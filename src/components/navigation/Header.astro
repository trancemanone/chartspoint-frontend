---
/**
 * Header Component - Premium Institutional Navigation
 *
 * ChartsPoint terminal-grade sticky header with:
 * - Logo on the right (RTL)
 * - Unified navigation triggers (no multi-color pills)
 * - Full-width mega menu with 4 pillars
 * - Custom trading iconography
 * - Mobile hamburger with slide-from-right drawer
 *
 * Design Philosophy:
 * This navigation embodies Bloomberg Terminal / Goldman Sachs aesthetic.
 * Clean, data-driven interface with sophisticated monochromatic base
 * and strategic teal accents. No colorful pills or template patterns.
 *
 * Optimized for Arabic readers ages 40-70 with WCAG AAA compliance.
 */

import MegaMenu from './MegaMenu.astro';
import type { PillarSlug } from '../../lib/types';

export interface Props {
  currentPillar?: PillarSlug;
  variant?: 'default' | 'dark';
}

const { currentPillar, variant = 'default' } = Astro.props;

// Navigation structure - 4 ChartsPoint pillars with custom icons
const navigation = [
  {
    id: 'basics' as PillarSlug,
    label: 'الأساسيات',
    labelEn: 'Basics',
    href: '/basics',
    // Custom candlestick foundation icon
    iconPath: 'M12 3v4M12 17v4M8 7h8v10H8V7zM10 10v4M14 10v4M6 21h12',
  },
  {
    id: 'indicators' as PillarSlug,
    label: 'المؤشرات',
    labelEn: 'Indicators',
    href: '/indicators',
    // Custom oscillator wave icon
    iconPath: 'M3 12h2l2-6 3 12 3-8 2 4h6M3 6h18M3 18h18',
  },
  {
    id: 'tools' as PillarSlug,
    label: 'الأدوات',
    labelEn: 'Tools',
    href: '/tools',
    // Custom chart grid with ruler icon
    iconPath: 'M4 4v16h16M8 4v16M12 4v16M16 4v16M4 8h16M4 12h16M4 16h16M20 4v4h-3',
  },
  {
    id: 'tactics' as PillarSlug,
    label: 'الاستراتيجيات',
    labelEn: 'Tactics',
    href: '/tactics',
    // Custom target with trend lines icon
    iconPath: 'M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0M12 12m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0M12 2v4M12 18v4M2 12h4M18 12h4M6 6l3 3M15 15l3 3',
  },
];
---

<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-to-content">
  انتقل إلى المحتوى الرئيسي
</a>

<header
  class:list={[
    'header-wrapper fixed top-0 left-0 right-0 z-header transition-all duration-300',
    variant === 'dark' ? 'header-dark' : 'header-light'
  ]}
  role="banner"
  data-header
>
  <div class="header-inner h-[88px] lg:h-[80px]">
    <div class="container mx-auto px-4 lg:px-6 h-full">
      <nav
        class="flex items-center justify-between h-full gap-4"
        role="navigation"
        aria-label="التنقل الرئيسي"
      >
        <!-- Logo (Right side in RTL) -->
        <a
          href="/"
          class="logo-link flex items-center flex-shrink-0"
          aria-label="ChartsPoint - الصفحة الرئيسية"
        >
          <!-- Logo - Desktop -->
          <div class="hidden lg:flex items-center gap-3">
            <div class="logo-mark w-12 h-12 rounded-xl bg-gradient-to-br from-navy-900 to-navy-800 flex items-center justify-center border border-navy-700/50 shadow-lg shadow-navy-900/20">
              <svg class="w-7 h-7 text-teal-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 3v18h18" />
                <path d="M7 16l4-8 4 4 5-9" />
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="font-heading text-xl font-bold text-navy-900 leading-tight tracking-tight">ChartsPoint</span>
              <span class="text-xs text-teal-600 font-medium leading-tight">تشارتس بوينت</span>
            </div>
          </div>

          <!-- Logo - Mobile (icon only) -->
          <div class="lg:hidden logo-mark w-12 h-12 rounded-xl bg-gradient-to-br from-navy-900 to-navy-800 flex items-center justify-center border border-navy-700/50 shadow-lg shadow-navy-900/20">
            <svg class="w-7 h-7 text-teal-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 3v18h18" />
              <path d="M7 16l4-8 4 4 5-9" />
            </svg>
          </div>
        </a>

        <!-- Desktop Navigation (Center) - Unified Terminal-Grade Triggers -->
        <div class="hidden lg:flex items-center" role="menubar">
          <div class="nav-container flex items-center gap-0.5 px-1 py-1 rounded-xl bg-slate-50/60 border border-slate-200/60">
            {navigation.map((item, index) => (
              <button
                type="button"
                class:list={[
                  'nav-trigger group relative flex items-center gap-2.5 px-4 py-2.5 rounded-lg font-medium text-[0.9375rem] transition-all duration-200',
                  currentPillar === item.id
                    ? 'bg-white shadow-sm text-navy-900'
                    : 'text-navy-600 hover:text-navy-900 hover:bg-white/80'
                ]}
                aria-expanded="false"
                aria-haspopup="true"
                aria-controls="mega-menu-panel"
                data-nav-trigger={item.id}
                data-nav-index={index}
              >
                <!-- Custom Pillar Icon -->
                <span class="nav-icon-wrapper relative w-5 h-5 flex items-center justify-center">
                  <span class="nav-icon-glow absolute inset-0 rounded-full bg-teal-500/0 group-hover:bg-teal-500/10 transition-all duration-300" aria-hidden="true"></span>
                  <svg
                    class="nav-icon relative w-[18px] h-[18px] text-slate-400 group-hover:text-teal-600 transition-colors duration-200"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <path d={item.iconPath} />
                  </svg>
                </span>

                <span class="nav-label">{item.label}</span>

                <!-- Chevron with rotation -->
                <svg
                  class="nav-chevron w-3.5 h-3.5 text-slate-400 group-hover:text-slate-500 transition-all duration-200"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
                </svg>

                <!-- Active/Hover Indicator Line -->
                <span class="nav-indicator absolute bottom-0 left-3 right-3 h-0.5 rounded-full bg-teal-500 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-right" aria-hidden="true"></span>
              </button>
            ))}
          </div>
        </div>

        <!-- Right Actions (Left side in RTL) -->
        <div class="flex items-center gap-2 lg:gap-3">
          <!-- CTA Button - Desktop only -->
          <a
            href="/basics"
            class="cta-btn hidden lg:inline-flex items-center gap-2 px-5 py-2.5 rounded-lg font-semibold text-[0.875rem] transition-all duration-200"
            aria-label="ابدأ تعلم التحليل الفني"
          >
            <span>ابدأ التعلم</span>
            <svg class="w-4 h-4 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>

          <!-- Mobile Menu Toggle -->
          <button
            type="button"
            class="mobile-menu-toggle lg:hidden touch-target flex items-center justify-center w-12 h-12 rounded-lg text-navy-700 hover:bg-slate-100 hover:text-navy-900 transition-all duration-200"
            aria-label="فتح القائمة"
            aria-expanded="false"
            aria-controls="mobile-menu"
            data-mobile-toggle
          >
            <svg
              class="hamburger-icon w-6 h-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg
              class="close-icon w-6 h-6 hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <!-- Full-Width Mega Menu Panel -->
  <MegaMenu currentPillar={currentPillar} />
</header>

<!-- Spacer for fixed header -->
<div class="h-[88px] lg:h-[80px]" aria-hidden="true"></div>

<style>
  /* ═══════════════════════════════════════════════════════════════════════════
     HEADER BASE STYLES - Terminal Grade
     ═══════════════════════════════════════════════════════════════════════════ */

  .header-wrapper {
    will-change: transform, background-color;
  }

  .header-light .header-inner {
    position: relative;
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid rgba(226, 232, 240, 0.6);
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04), 0 4px 24px rgba(15, 23, 42, 0.04);
  }

  /* Premium teal accent line at bottom */
  .header-light .header-inner::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent 0%, #0891B2 20%, #0891B2 80%, transparent 100%);
    opacity: 0.4;
  }

  .header-dark .header-inner {
    background: rgba(16, 42, 67, 0.95);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  /* Scrolled state */
  .header-wrapper.is-scrolled .header-inner {
    box-shadow: 0 4px 30px rgba(15, 23, 42, 0.08);
  }

  .header-wrapper.is-scrolled.header-light .header-inner {
    background: rgba(255, 255, 255, 0.98);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     LOGO STYLES
     ═══════════════════════════════════════════════════════════════════════════ */

  .logo-link:focus-visible {
    outline: none;
    border-radius: 0.75rem;
  }

  .logo-link:focus-visible .logo-mark {
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  .logo-mark {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .logo-link:hover .logo-mark {
    transform: scale(1.02);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     NAV CONTAINER - Unified Terminal Style
     ═══════════════════════════════════════════════════════════════════════════ */

  .nav-container {
    background: linear-gradient(180deg, rgba(248, 250, 252, 0.6) 0%, rgba(241, 245, 249, 0.4) 100%);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     NAV TRIGGER STYLES - Premium Unified Design
     ═══════════════════════════════════════════════════════════════════════════ */

  .nav-trigger {
    position: relative;
    overflow: hidden;
  }

  .nav-trigger::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.7) 100%);
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 0.5rem;
  }

  .nav-trigger:hover::before {
    opacity: 1;
  }

  .nav-trigger[aria-expanded="true"]::before {
    opacity: 1;
    background: linear-gradient(180deg, rgba(255, 255, 255, 1) 0%, rgba(248, 250, 252, 0.9) 100%);
  }

  /* Icon styling */
  .nav-icon-wrapper {
    transition: transform 0.2s ease;
  }

  .nav-trigger:hover .nav-icon-wrapper {
    transform: scale(1.1);
  }

  .nav-trigger[aria-expanded="true"] .nav-icon {
    color: theme('colors.teal.600');
  }

  .nav-trigger[aria-expanded="true"] .nav-icon-glow {
    background: rgba(8, 145, 178, 0.15);
    box-shadow: 0 0 12px rgba(8, 145, 178, 0.2);
  }

  /* Label styling */
  .nav-label {
    position: relative;
    z-index: 1;
  }

  /* Chevron rotation */
  .nav-trigger[aria-expanded="true"] .nav-chevron {
    transform: rotate(180deg);
    color: theme('colors.teal.600');
  }

  /* Active indicator */
  .nav-trigger[aria-expanded="true"] .nav-indicator {
    transform: scaleX(1);
  }

  /* Focus state */
  .nav-trigger:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px white, 0 0 0 4px theme('colors.teal.500');
  }

  /* Active state styling */
  .nav-trigger[aria-expanded="true"] {
    background: white;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.04);
    color: theme('colors.navy.900');
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CTA BUTTON STYLES - Teal Gradient
     ═══════════════════════════════════════════════════════════════════════════ */

  .cta-btn {
    position: relative;
    background: linear-gradient(135deg, #14B8A6 0%, #0891B2 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(8, 145, 178, 0.25);
    border: 1px solid rgba(8, 145, 178, 0.3);
    overflow: hidden;
  }

  .cta-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .cta-btn:hover {
    background: linear-gradient(135deg, #0D9488 0%, #0E7490 100%);
    box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4);
    transform: translateY(-1px);
  }

  .cta-btn:hover::before {
    opacity: 1;
  }

  .cta-btn:active {
    transform: translateY(0);
  }

  .cta-btn:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     MOBILE TOGGLE
     ═══════════════════════════════════════════════════════════════════════════ */

  .mobile-menu-toggle:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     SKIP TO CONTENT - Accessibility
     ═══════════════════════════════════════════════════════════════════════════ */

  .skip-to-content {
    position: absolute;
    top: -100%;
    right: 1rem;
    padding: 1rem 2rem;
    background: theme('colors.navy.900');
    color: white;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 0.5rem;
    text-decoration: underline;
    text-underline-offset: 4px;
    z-index: 9999;
    transition: top 0.2s ease;
  }

  .skip-to-content:focus {
    top: 1rem;
    box-shadow: 0 8px 32px rgba(15, 23, 42, 0.2);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     MOBILE OPTIMIZATIONS
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (max-width: 1023px) {
    .header-inner {
      overflow: hidden;
    }

    nav[role="navigation"] {
      flex-wrap: nowrap;
    }

    .mobile-menu-toggle {
      flex-shrink: 0;
      touch-action: manipulation;
    }

    .logo-link {
      min-width: 48px;
    }
  }

  @media (max-width: 360px) {
    .header-inner {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     REDUCED MOTION
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (prefers-reduced-motion: reduce) {
    .header-wrapper,
    .nav-trigger,
    .nav-chevron,
    .nav-icon-wrapper,
    .cta-btn,
    .logo-mark {
      transition: none;
      animation: none;
    }
  }
</style>

<script>
  // Header scroll state management and Mega Menu control
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('[data-header]') as HTMLElement;
    const mobileToggle = document.querySelector('[data-mobile-toggle]') as HTMLButtonElement;
    const hamburgerIcon = document.querySelector('.hamburger-icon') as SVGElement;
    const closeIcon = document.querySelector('.close-icon') as SVGElement;
    const megaMenu = document.querySelector('[data-mega-menu-panel]') as HTMLElement;
    const navTriggers = document.querySelectorAll('[data-nav-trigger]');

    // Track mega menu state
    let isMegaMenuOpen = false;
    let activeNavTrigger: HTMLButtonElement | null = null;

    // Scroll state
    let isScrolled = false;

    function handleScroll() {
      const currentScroll = window.scrollY;

      if (currentScroll > 20 && !isScrolled) {
        header?.classList.add('is-scrolled');
        isScrolled = true;
      } else if (currentScroll <= 20 && isScrolled) {
        header?.classList.remove('is-scrolled');
        isScrolled = false;
      }
    }

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();

    // ═══════════════════════════════════════════════════════════════════════════
    // MEGA MENU CONTROL
    // ═══════════════════════════════════════════════════════════════════════════

    function openMegaMenu(trigger: HTMLButtonElement) {
      if (megaMenu && trigger) {
        if (activeNavTrigger && activeNavTrigger !== trigger) {
          activeNavTrigger.setAttribute('aria-expanded', 'false');
        }

        megaMenu.classList.add('is-open');
        megaMenu.removeAttribute('hidden');
        trigger.setAttribute('aria-expanded', 'true');
        activeNavTrigger = trigger;
        isMegaMenuOpen = true;

        const clusterLinks = megaMenu.querySelectorAll('[data-cluster-link]');
        clusterLinks.forEach((link) => {
          link.setAttribute('tabindex', '0');
        });
      }
    }

    function closeMegaMenu() {
      if (megaMenu && isMegaMenuOpen) {
        megaMenu.classList.remove('is-open');

        navTriggers.forEach((trigger) => {
          trigger.setAttribute('aria-expanded', 'false');
        });

        const clusterLinks = megaMenu.querySelectorAll('[data-cluster-link]');
        clusterLinks.forEach((link) => {
          link.setAttribute('tabindex', '-1');
        });

        activeNavTrigger = null;
        isMegaMenuOpen = false;

        setTimeout(() => {
          if (!isMegaMenuOpen) {
            megaMenu.setAttribute('hidden', '');
          }
        }, 300);
      }
    }

    function toggleMegaMenu(trigger: HTMLButtonElement) {
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        closeMegaMenu();
      } else {
        openMegaMenu(trigger);
      }
    }

    // Nav trigger click handlers
    navTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        toggleMegaMenu(trigger as HTMLButtonElement);
      });

      trigger.addEventListener('keydown', (e: Event) => {
        const keyEvent = e as KeyboardEvent;

        if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
          keyEvent.preventDefault();
          toggleMegaMenu(trigger as HTMLButtonElement);
        }

        if (keyEvent.key === 'ArrowDown') {
          keyEvent.preventDefault();
          openMegaMenu(trigger as HTMLButtonElement);
          setTimeout(() => {
            const firstLink = megaMenu?.querySelector('[data-cluster-link]') as HTMLElement;
            firstLink?.focus();
          }, 150);
        }

        if (keyEvent.key === 'Escape' && isMegaMenuOpen) {
          closeMegaMenu();
          (trigger as HTMLElement).focus();
        }
      });

      // Hover to open
      let hoverTimeout: ReturnType<typeof setTimeout>;

      trigger.addEventListener('mouseenter', () => {
        clearTimeout(hoverTimeout);
        hoverTimeout = setTimeout(() => {
          openMegaMenu(trigger as HTMLButtonElement);
        }, 120);
      });

      trigger.addEventListener('mouseleave', () => {
        clearTimeout(hoverTimeout);
      });
    });

    // Close mega menu when mouse leaves header area
    header?.addEventListener('mouseleave', () => {
      setTimeout(() => {
        if (!header?.matches(':hover') && !megaMenu?.matches(':hover')) {
          closeMegaMenu();
        }
      }, 100);
    });

    megaMenu?.addEventListener('mouseenter', () => {
      // Keep open
    });

    megaMenu?.addEventListener('mouseleave', () => {
      setTimeout(() => {
        if (!header?.matches(':hover') && !megaMenu?.matches(':hover')) {
          closeMegaMenu();
        }
      }, 100);
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('[data-header]') && isMegaMenuOpen) {
        closeMegaMenu();
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMegaMenuOpen) {
        closeMegaMenu();
        activeNavTrigger?.focus();
      }
    });

    // Tab trapping within mega menu
    megaMenu?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Tab' && !e.shiftKey) {
        const focusableElements = megaMenu.querySelectorAll(
          'a[href], button:not([disabled])'
        );
        const lastElement = focusableElements[focusableElements.length - 1];

        if (document.activeElement === lastElement) {
          e.preventDefault();
          closeMegaMenu();
          activeNavTrigger?.focus();
        }
      }

      if (e.key === 'Tab' && e.shiftKey) {
        const focusableElements = megaMenu.querySelectorAll(
          'a[href], button:not([disabled])'
        );
        const firstElement = focusableElements[0];

        if (document.activeElement === firstElement) {
          e.preventDefault();
          closeMegaMenu();
          activeNavTrigger?.focus();
        }
      }
    });

    // Mobile menu sync
    document.addEventListener('mobile-menu:closed', () => {
      hamburgerIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
      mobileToggle?.setAttribute('aria-expanded', 'false');
      mobileToggle?.setAttribute('aria-label', 'فتح القائمة');
    });
  });
</script>
