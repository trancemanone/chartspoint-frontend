---
/**
 * Header Component - Premium Institutional Navigation
 *
 * ChartsPoint glassmorphism sticky header with:
 * - Logo on the right (RTL)
 * - Full-width mega menu with 4 pillars: Basics, Indicators, Tools, Tactics
 * - Each pillar has its own color (basics=blue, indicators=orange, tools=green, tactics=purple)
 * - Mobile hamburger with slide-from-right drawer
 * - Educational CTA button
 *
 * Design Philosophy:
 * This navigation embodies the visual language of institutional fintech.
 * The full-width mega menu creates an immersive experience that showcases
 * all content pillars simultaneously, reinforcing the platform's comprehensive
 * approach to technical analysis education.
 *
 * Optimized for Arabic readers ages 40-70 with WCAG AAA compliance.
 */

import MegaMenu from './MegaMenu.astro';
import type { PillarSlug } from '../../lib/types';
import { PILLARS } from '../../lib/types';

export interface Props {
  currentPillar?: PillarSlug;
  variant?: 'default' | 'dark';
}

const { currentPillar, variant = 'default' } = Astro.props;

// Navigation structure for trigger buttons - 4 ChartsPoint pillars
const navigation = [
  {
    id: 'basics' as PillarSlug,
    label: 'الأساسيات',
    labelShort: 'أساسيات',
    href: '/basics',
    colorClass: 'text-basics-600',
    bgClass: 'bg-basics-50',
    borderClass: 'border-basics-500',
    hoverBg: 'hover:bg-basics-50',
  },
  {
    id: 'indicators' as PillarSlug,
    label: 'المؤشرات',
    labelShort: 'مؤشرات',
    href: '/indicators',
    colorClass: 'text-indicators-600',
    bgClass: 'bg-indicators-50',
    borderClass: 'border-indicators-500',
    hoverBg: 'hover:bg-indicators-50',
  },
  {
    id: 'tools' as PillarSlug,
    label: 'الأدوات',
    labelShort: 'أدوات',
    href: '/tools',
    colorClass: 'text-tools-600',
    bgClass: 'bg-tools-50',
    borderClass: 'border-tools-500',
    hoverBg: 'hover:bg-tools-50',
  },
  {
    id: 'tactics' as PillarSlug,
    label: 'الاستراتيجيات',
    labelShort: 'استراتيجيات',
    href: '/tactics',
    colorClass: 'text-tactics-600',
    bgClass: 'bg-tactics-50',
    borderClass: 'border-tactics-500',
    hoverBg: 'hover:bg-tactics-50',
  },
];
---

<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-to-content">
  انتقل إلى المحتوى الرئيسي
</a>

<header
  class:list={[
    'header-wrapper fixed top-0 left-0 right-0 z-header transition-all duration-300',
    variant === 'dark' ? 'header-dark' : 'header-light'
  ]}
  role="banner"
  data-header
>
  <div class="header-inner h-[88px] lg:h-[80px]">
    <div class="container mx-auto px-4 lg:px-6 h-full">
      <nav
        class="flex items-center justify-between h-full gap-4"
        role="navigation"
        aria-label="التنقل الرئيسي"
      >
        <!-- Logo (Right side in RTL) -->
        <a
          href="/"
          class="logo-link flex items-center flex-shrink-0"
          aria-label="ChartsPoint - الصفحة الرئيسية"
        >
          <!-- Logo - Desktop -->
          <div class="hidden lg:flex items-center gap-3">
            <div class="logo-mark w-12 h-12 rounded-xl bg-gradient-to-br from-navy-900 to-navy-800 flex items-center justify-center border border-navy-700/50">
              <svg class="w-7 h-7 text-teal-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 3v18h18" />
                <path d="M7 16l4-8 4 4 5-9" />
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="font-heading text-xl font-bold text-navy-900 leading-tight">ChartsPoint</span>
              <span class="text-xs text-teal-600 leading-tight">تشارتس بوينت</span>
            </div>
          </div>

          <!-- Logo - Mobile (icon only) -->
          <div class="lg:hidden logo-mark w-12 h-12 rounded-xl bg-gradient-to-br from-navy-900 to-navy-800 flex items-center justify-center border border-navy-700/50">
            <svg class="w-7 h-7 text-teal-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 3v18h18" />
              <path d="M7 16l4-8 4 4 5-9" />
            </svg>
          </div>
        </a>

        <!-- Desktop Navigation (Center) - Mega Menu Triggers for 4 Pillars -->
        <div class="hidden lg:flex items-center gap-1" role="menubar">
          {navigation.map((item) => (
            <button
              type="button"
              class:list={[
                'nav-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium text-[0.9375rem] transition-all duration-200',
                currentPillar === item.id
                  ? `${item.colorClass} ${item.bgClass}`
                  : `text-navy-700 ${item.hoverBg}`
              ]}
              aria-expanded="false"
              aria-haspopup="true"
              aria-controls="mega-menu-panel"
              data-nav-trigger={item.id}
            >
              <span>{item.label}</span>
              <svg
                class="nav-chevron w-4 h-4 transition-transform duration-200"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
          ))}
        </div>

        <!-- Right Actions (Left side in RTL) -->
        <div class="flex items-center gap-2 lg:gap-3">
          <!-- CTA Button - Desktop only - EDUCATIONAL focus -->
          <a
            href="/basics"
            class="cta-btn hidden lg:inline-flex items-center gap-2 px-5 py-2.5 rounded-lg font-semibold text-[0.875rem] transition-all duration-200"
            aria-label="ابدأ تعلم التحليل الفني"
          >
            <span>ابدأ من الأساسيات</span>
            <svg class="w-4 h-4 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>

          <!-- Mobile Menu Toggle -->
          <button
            type="button"
            class="mobile-menu-toggle lg:hidden touch-target flex items-center justify-center w-12 h-12 rounded-lg text-navy-700 hover:bg-slate-100 hover:text-navy-900 transition-all duration-200"
            aria-label="فتح القائمة"
            aria-expanded="false"
            aria-controls="mobile-menu"
            data-mobile-toggle
          >
            <svg
              class="hamburger-icon w-6 h-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg
              class="close-icon w-6 h-6 hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <!-- Full-Width Mega Menu Panel -->
  <MegaMenu currentPillar={currentPillar} />
</header>

<!-- Spacer for fixed header -->
<div class="h-[88px] lg:h-[80px]" aria-hidden="true"></div>

<style>
  /* ═══════════════════════════════════════════════════════════════════════════
     HEADER BASE STYLES
     ═══════════════════════════════════════════════════════════════════════════ */

  .header-wrapper {
    will-change: transform, background-color;
  }

  .header-light .header-inner {
    position: relative;
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid rgba(226, 232, 240, 0.6);
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04), 0 4px 24px rgba(15, 23, 42, 0.04);
  }

  /* Premium teal accent line at bottom - institutional quality indicator */
  .header-light .header-inner::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent 0%, #0891B2 20%, #0891B2 80%, transparent 100%);
    opacity: 0.4;
  }

  .header-dark .header-inner {
    background: rgba(16, 42, 67, 0.95);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .header-dark .nav-trigger {
    color: rgba(255, 255, 255, 0.9);
  }

  .header-dark .nav-trigger:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  /* Scrolled state */
  .header-wrapper.is-scrolled .header-inner {
    box-shadow: 0 4px 30px rgba(15, 23, 42, 0.08);
  }

  .header-wrapper.is-scrolled.header-light .header-inner {
    background: rgba(255, 255, 255, 0.98);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     LOGO STYLES
     ═══════════════════════════════════════════════════════════════════════════ */

  .logo-link:focus-visible {
    outline: none;
    border-radius: 0.75rem;
  }

  .logo-link:focus-visible .logo-mark {
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  .logo-mark {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .logo-link:hover .logo-mark {
    transform: scale(1.02);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     NAV TRIGGER STYLES - Premium Interaction Design
     ═══════════════════════════════════════════════════════════════════════════ */

  .nav-trigger {
    position: relative;
  }

  /* Underline indicator */
  .nav-trigger::after {
    content: '';
    position: absolute;
    bottom: 0.375rem;
    right: 1rem;
    left: 1rem;
    height: 2px;
    background: transparent;
    border-radius: 1px;
    transform: scaleX(0);
    transition: transform 0.2s ease, background 0.2s ease;
  }

  .nav-trigger:hover::after,
  .nav-trigger[aria-expanded="true"]::after {
    transform: scaleX(1);
  }

  /* Pillar-specific underline colors */
  .nav-trigger[data-nav-trigger="basics"]:hover::after,
  .nav-trigger[data-nav-trigger="basics"][aria-expanded="true"]::after {
    background: theme('colors.basics.500');
  }

  .nav-trigger[data-nav-trigger="indicators"]:hover::after,
  .nav-trigger[data-nav-trigger="indicators"][aria-expanded="true"]::after {
    background: theme('colors.indicators.500');
  }

  .nav-trigger[data-nav-trigger="tools"]:hover::after,
  .nav-trigger[data-nav-trigger="tools"][aria-expanded="true"]::after {
    background: theme('colors.tools.500');
  }

  .nav-trigger[data-nav-trigger="tactics"]:hover::after,
  .nav-trigger[data-nav-trigger="tactics"][aria-expanded="true"]::after {
    background: theme('colors.tactics.500');
  }

  /* Chevron rotation */
  .nav-trigger[aria-expanded="true"] .nav-chevron {
    transform: rotate(180deg);
  }

  .nav-trigger:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  /* Active/Expanded state background */
  .nav-trigger[aria-expanded="true"] {
    background: theme('colors.slate.100');
  }

  .nav-trigger[data-nav-trigger="basics"][aria-expanded="true"] {
    background: theme('colors.basics.50');
    color: theme('colors.basics.700');
  }

  .nav-trigger[data-nav-trigger="indicators"][aria-expanded="true"] {
    background: theme('colors.indicators.50');
    color: theme('colors.indicators.700');
  }

  .nav-trigger[data-nav-trigger="tools"][aria-expanded="true"] {
    background: theme('colors.tools.50');
    color: theme('colors.tools.700');
  }

  .nav-trigger[data-nav-trigger="tactics"][aria-expanded="true"] {
    background: theme('colors.tactics.50');
    color: theme('colors.tactics.700');
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CTA BUTTON STYLES - Teal Gradient (Educational Focus)
     ═══════════════════════════════════════════════════════════════════════════ */

  .cta-btn {
    background: linear-gradient(135deg, #14B8A6 0%, #0891B2 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(8, 145, 178, 0.25);
    border: 1px solid rgba(8, 145, 178, 0.3);
  }

  .cta-btn:hover {
    background: linear-gradient(135deg, #0D9488 0%, #0E7490 100%);
    box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4);
    transform: translateY(-1px);
  }

  .cta-btn:active {
    transform: translateY(0);
  }

  .cta-btn:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     MOBILE TOGGLE
     ═══════════════════════════════════════════════════════════════════════════ */

  .mobile-menu-toggle:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px white, 0 0 0 6px theme('colors.teal.500');
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     SKIP TO CONTENT - Accessibility
     ═══════════════════════════════════════════════════════════════════════════ */

  .skip-to-content {
    position: absolute;
    top: -100%;
    right: 1rem;
    padding: 1rem 2rem;
    background: theme('colors.navy.900');
    color: white;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 0.5rem;
    text-decoration: underline;
    text-underline-offset: 4px;
    z-index: 9999;
    transition: top 0.2s ease;
  }

  .skip-to-content:focus {
    top: 1rem;
    box-shadow: 0 8px 32px rgba(15, 23, 42, 0.2);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     REDUCED MOTION
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (prefers-reduced-motion: reduce) {
    .header-wrapper,
    .nav-trigger,
    .nav-chevron,
    .cta-btn,
    .logo-mark {
      transition: none;
      animation: none;
    }
  }
</style>

<script>
  // Header scroll state management and Mega Menu control
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('[data-header]') as HTMLElement;
    const mobileToggle = document.querySelector('[data-mobile-toggle]') as HTMLButtonElement;
    const hamburgerIcon = document.querySelector('.hamburger-icon') as SVGElement;
    const closeIcon = document.querySelector('.close-icon') as SVGElement;
    const megaMenu = document.querySelector('[data-mega-menu-panel]') as HTMLElement;
    const navTriggers = document.querySelectorAll('[data-nav-trigger]');

    // Track mega menu state
    let isMegaMenuOpen = false;
    let activeNavTrigger: HTMLButtonElement | null = null;

    // Scroll state
    let isScrolled = false;

    function handleScroll() {
      const currentScroll = window.scrollY;

      // Add/remove scrolled class
      if (currentScroll > 20 && !isScrolled) {
        header?.classList.add('is-scrolled');
        isScrolled = true;
      } else if (currentScroll <= 20 && isScrolled) {
        header?.classList.remove('is-scrolled');
        isScrolled = false;
      }
    }

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll(); // Check initial state

    // ═══════════════════════════════════════════════════════════════════════════
    // MEGA MENU CONTROL - Full Width Panel
    // ═══════════════════════════════════════════════════════════════════════════

    function openMegaMenu(trigger: HTMLButtonElement) {
      if (megaMenu && trigger) {
        // Close any previously active trigger
        if (activeNavTrigger && activeNavTrigger !== trigger) {
          activeNavTrigger.setAttribute('aria-expanded', 'false');
        }

        // Open the mega menu
        megaMenu.classList.add('is-open');
        megaMenu.removeAttribute('hidden');
        trigger.setAttribute('aria-expanded', 'true');
        activeNavTrigger = trigger;
        isMegaMenuOpen = true;

        // Make all cluster links focusable
        const clusterLinks = megaMenu.querySelectorAll('[data-cluster-link]');
        clusterLinks.forEach((link) => {
          link.setAttribute('tabindex', '0');
        });
      }
    }

    function closeMegaMenu() {
      if (megaMenu && isMegaMenuOpen) {
        megaMenu.classList.remove('is-open');

        // Reset all nav triggers
        navTriggers.forEach((trigger) => {
          trigger.setAttribute('aria-expanded', 'false');
        });

        // Reset tabindex on all cluster links
        const clusterLinks = megaMenu.querySelectorAll('[data-cluster-link]');
        clusterLinks.forEach((link) => {
          link.setAttribute('tabindex', '-1');
        });

        activeNavTrigger = null;
        isMegaMenuOpen = false;

        // Hide after transition completes
        setTimeout(() => {
          if (!isMegaMenuOpen) {
            megaMenu.setAttribute('hidden', '');
          }
        }, 300);
      }
    }

    function toggleMegaMenu(trigger: HTMLButtonElement) {
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        closeMegaMenu();
      } else {
        openMegaMenu(trigger);
      }
    }

    // Nav trigger click handlers
    navTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        toggleMegaMenu(trigger as HTMLButtonElement);
      });

      // Keyboard support for nav triggers
      trigger.addEventListener('keydown', (e: Event) => {
        const keyEvent = e as KeyboardEvent;

        if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
          keyEvent.preventDefault();
          toggleMegaMenu(trigger as HTMLButtonElement);
        }

        if (keyEvent.key === 'ArrowDown') {
          keyEvent.preventDefault();
          openMegaMenu(trigger as HTMLButtonElement);
          // Focus first link after animation
          setTimeout(() => {
            const firstLink = megaMenu?.querySelector('[data-cluster-link]') as HTMLElement;
            firstLink?.focus();
          }, 150);
        }

        if (keyEvent.key === 'Escape' && isMegaMenuOpen) {
          closeMegaMenu();
          (trigger as HTMLElement).focus();
        }
      });

      // Hover to open (with slight delay for better UX)
      let hoverTimeout: ReturnType<typeof setTimeout>;

      trigger.addEventListener('mouseenter', () => {
        clearTimeout(hoverTimeout);
        hoverTimeout = setTimeout(() => {
          openMegaMenu(trigger as HTMLButtonElement);
        }, 120);
      });

      trigger.addEventListener('mouseleave', () => {
        clearTimeout(hoverTimeout);
      });
    });

    // Close mega menu when mouse leaves the entire header area
    header?.addEventListener('mouseleave', () => {
      // Delay to allow moving between nav triggers and mega menu
      setTimeout(() => {
        if (!header?.matches(':hover') && !megaMenu?.matches(':hover')) {
          closeMegaMenu();
        }
      }, 100);
    });

    // Keep mega menu open when hovering over it
    megaMenu?.addEventListener('mouseenter', () => {
      // Menu is being hovered, keep it open
    });

    megaMenu?.addEventListener('mouseleave', () => {
      // Close when leaving the mega menu
      setTimeout(() => {
        if (!header?.matches(':hover') && !megaMenu?.matches(':hover')) {
          closeMegaMenu();
        }
      }, 100);
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('[data-header]') && isMegaMenuOpen) {
        closeMegaMenu();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMegaMenuOpen) {
        closeMegaMenu();
        activeNavTrigger?.focus();
      }
    });

    // Keyboard navigation within mega menu (Tab trapping)
    megaMenu?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Tab' && !e.shiftKey) {
        // Check if we're on the last focusable element
        const focusableElements = megaMenu.querySelectorAll(
          'a[href], button:not([disabled])'
        );
        const lastElement = focusableElements[focusableElements.length - 1];

        if (document.activeElement === lastElement) {
          e.preventDefault();
          closeMegaMenu();
          activeNavTrigger?.focus();
        }
      }

      if (e.key === 'Tab' && e.shiftKey) {
        // Check if we're on the first focusable element
        const focusableElements = megaMenu.querySelectorAll(
          'a[href], button:not([disabled])'
        );
        const firstElement = focusableElements[0];

        if (document.activeElement === firstElement) {
          e.preventDefault();
          closeMegaMenu();
          activeNavTrigger?.focus();
        }
      }
    });

    // ═══════════════════════════════════════════════════════════════════════════
    // MOBILE MENU TOGGLE
    // ═══════════════════════════════════════════════════════════════════════════

    mobileToggle?.addEventListener('click', () => {
      const isExpanded = mobileToggle.getAttribute('aria-expanded') === 'true';

      if (!isExpanded) {
        // Open mobile menu
        document.dispatchEvent(new CustomEvent('mobile-menu:open'));
        hamburgerIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
        mobileToggle.setAttribute('aria-expanded', 'true');
        mobileToggle.setAttribute('aria-label', 'إغلاق القائمة');
      } else {
        // Close mobile menu
        document.dispatchEvent(new CustomEvent('mobile-menu:close'));
        hamburgerIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        mobileToggle.setAttribute('aria-expanded', 'false');
        mobileToggle.setAttribute('aria-label', 'فتح القائمة');
      }
    });

    // Listen for mobile menu close event to reset toggle state
    document.addEventListener('mobile-menu:closed', () => {
      hamburgerIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
      mobileToggle?.setAttribute('aria-expanded', 'false');
      mobileToggle?.setAttribute('aria-label', 'فتح القائمة');
    });
  });
</script>
