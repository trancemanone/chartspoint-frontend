---
/**
 * MegaMenu Component - ChartsPoint Premium Navigation Panel
 *
 * Institutional-grade mega menu featuring 4 pillars:
 * - Basics (blue) - Technical analysis fundamentals
 * - Indicators (orange) - Technical indicators
 * - Tools (green) - Charting tools and calculators
 * - Tactics (purple) - Strategies and risk management
 *
 * Design: Bloomberg/Goldman Sachs-tier with:
 * - Sophisticated glassmorphism
 * - Gold accent system
 * - Staggered entrance animations
 * - Full RTL Arabic support
 * - WCAG AAA compliance
 */

import { getPostsByPillar, transformToArticle } from '../../lib/wordpress';
import { CLUSTERS, PILLARS, type PillarSlug } from '../../lib/types';

export interface Props {
  currentPillar?: PillarSlug;
}

const { currentPillar } = Astro.props;

// Fetch articles for each pillar from WordPress
const [basicsPosts, indicatorsPosts, toolsPosts, tacticsPosts] = await Promise.all([
  getPostsByPillar('basics', 4).catch(() => ({ data: [] })),
  getPostsByPillar('indicators', 4).catch(() => ({ data: [] })),
  getPostsByPillar('tools', 4).catch(() => ({ data: [] })),
  getPostsByPillar('tactics', 4).catch(() => ({ data: [] })),
]);

// Transform posts to articles
const basicsArticles = basicsPosts.data.map(transformToArticle);
const indicatorsArticles = indicatorsPosts.data.map(transformToArticle);
const toolsArticles = toolsPosts.data.map(transformToArticle);
const tacticsArticles = tacticsPosts.data.map(transformToArticle);

// Get clusters for each pillar
const basicsClusters = CLUSTERS.filter(c => c.pillar === 'basics');
const indicatorsClusters = CLUSTERS.filter(c => c.pillar === 'indicators');
const toolsClusters = CLUSTERS.filter(c => c.pillar === 'tools');
const tacticsClusters = CLUSTERS.filter(c => c.pillar === 'tactics');

// Cluster descriptions
function getClusterDescription(slug: string): string {
  const descriptions: Record<string, string> = {
    'intro': 'مقدمة شاملة للتحليل الفني',
    'patterns': 'أنماط الشموع والرسوم البيانية',
    'action': 'فهم حركة السعر',
    'methods': 'طرق التحليل المختلفة',
    'momentum': 'مؤشرات الزخم والقوة',
    'trend': 'مؤشرات تحديد الاتجاه',
    'volatility': 'قياس التذبذب والتقلبات',
    'volume': 'تحليل حجم التداول',
    'calc': 'حاسبات التداول المختلفة',
    'charts': 'أدوات الرسم البياني',
    'data': 'مصادر البيانات المالية',
    'trend-tactics': 'استراتيجيات تتبع الاتجاه',
    'reversion': 'استراتيجيات الارتداد',
    'intraday': 'التداول خلال اليوم',
    'risk': 'إدارة المخاطر والرأسمال',
  };
  return descriptions[slug] || '';
}

// Icon paths
const icons = {
  book: 'M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25',
  chart: 'M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605',
  calculator: 'M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V13.5zm0 2.25h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V18zm2.498-6.75h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V13.5zm0 2.25h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V18zm2.504-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zm0 2.25h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V18zm2.498-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zM8.25 6h7.5v2.25h-7.5V6zM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0012 2.25z',
  target: 'M15 10.5a3 3 0 11-6 0 3 3 0 016 0z M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z',
  sparkle: 'M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z',
};

// Build pillar data
const pillars = [
  {
    id: 'basics' as PillarSlug,
    label: 'الأساسيات',
    labelEn: 'Basics',
    href: '/basics',
    description: PILLARS.basics.description,
    icon: 'book',
    colorHex: '#3B82F6',
    gradientFrom: '#3B82F6',
    gradientTo: '#1D4ED8',
    glowColor: 'rgba(59, 130, 246, 0.15)',
    clusters: basicsClusters.map(cluster => ({
      label: cluster.nameAr,
      href: `/basics/${cluster.slug}`,
      description: getClusterDescription(cluster.slug),
    })),
    articles: basicsArticles.slice(0, 2),
  },
  {
    id: 'indicators' as PillarSlug,
    label: 'المؤشرات',
    labelEn: 'Indicators',
    href: '/indicators',
    description: PILLARS.indicators.description,
    icon: 'chart',
    colorHex: '#F97316',
    gradientFrom: '#F97316',
    gradientTo: '#EA580C',
    glowColor: 'rgba(249, 115, 22, 0.15)',
    clusters: indicatorsClusters.map(cluster => ({
      label: cluster.nameAr,
      href: `/indicators/${cluster.slug}`,
      description: getClusterDescription(cluster.slug),
    })),
    articles: indicatorsArticles.slice(0, 2),
  },
  {
    id: 'tools' as PillarSlug,
    label: 'الأدوات',
    labelEn: 'Tools',
    href: '/tools',
    description: PILLARS.tools.description,
    icon: 'calculator',
    colorHex: '#10B981',
    gradientFrom: '#10B981',
    gradientTo: '#059669',
    glowColor: 'rgba(16, 185, 129, 0.15)',
    clusters: toolsClusters.map(cluster => ({
      label: cluster.nameAr,
      href: `/tools/${cluster.slug}`,
      description: getClusterDescription(cluster.slug),
    })),
    articles: toolsArticles.slice(0, 2),
  },
  {
    id: 'tactics' as PillarSlug,
    label: 'الاستراتيجيات',
    labelEn: 'Tactics',
    href: '/tactics',
    description: PILLARS.tactics.description,
    icon: 'target',
    colorHex: '#8B5CF6',
    gradientFrom: '#8B5CF6',
    gradientTo: '#7C3AED',
    glowColor: 'rgba(139, 92, 246, 0.15)',
    clusters: tacticsClusters.map(cluster => ({
      label: cluster.nameAr,
      href: `/tactics/${cluster.slug}`,
      description: getClusterDescription(cluster.slug),
    })),
    articles: tacticsArticles.slice(0, 2),
  },
];
---

<!-- Premium Contained Mega Menu -->
<div
  id="mega-menu-panel"
  class="mega-menu-panel"
  role="navigation"
  aria-label="القائمة الرئيسية الموسعة"
  data-mega-menu-panel
  hidden
>
  <!-- Layered Background -->
  <div class="mega-menu-backdrop">
    <div class="backdrop-glass"></div>
    <div class="backdrop-pattern"></div>
    <div class="backdrop-glow glow-basics"></div>
    <div class="backdrop-glow glow-indicators"></div>
    <div class="backdrop-glow glow-tools"></div>
    <div class="backdrop-glow glow-tactics"></div>
    <div class="backdrop-teal-line"></div>
  </div>

  <!-- Menu Content -->
  <div class="mega-menu-content">
    <div class="container mx-auto px-6 lg:px-8">
      <!-- 4-Column Pillar Grid -->
      <div class="mega-menu-grid">
        {pillars.map((pillar, pillarIndex) => (
          <div
            class="pillar-column"
            data-pillar-column={pillar.id}
            style={`--pillar-color: ${pillar.colorHex}; --pillar-gradient-from: ${pillar.gradientFrom}; --pillar-gradient-to: ${pillar.gradientTo}; --pillar-glow: ${pillar.glowColor}; --pillar-delay: ${pillarIndex * 60}ms`}
          >
            <!-- Pillar Header -->
            <div class="pillar-header">
              <div class="pillar-accent-bar" aria-hidden="true"></div>

              <div class="pillar-icon-container">
                <div class="pillar-icon-glow" aria-hidden="true"></div>
                <div class="pillar-icon-wrapper">
                  <svg
                    class="pillar-icon"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="1.5"
                    aria-hidden="true"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d={icons[pillar.icon as keyof typeof icons]} />
                  </svg>
                </div>
              </div>

              <div class="pillar-header-content">
                <div class="pillar-title-group">
                  <h3 class="pillar-title">{pillar.label}</h3>
                  <span class="pillar-title-en">{pillar.labelEn}</span>
                </div>
                <p class="pillar-description">{pillar.description}</p>
              </div>
            </div>

            <!-- Cluster Links -->
            <div class="pillar-clusters">
              {pillar.clusters.map((cluster, clusterIndex) => (
                <a
                  href={cluster.href}
                  class="cluster-link"
                  role="menuitem"
                  tabindex="-1"
                  data-cluster-link
                  style={`--cluster-delay: ${(pillarIndex * 60) + (clusterIndex * 30) + 80}ms`}
                >
                  <div class="cluster-indicator-wrapper">
                    <span class="cluster-indicator" aria-hidden="true"></span>
                    <span class="cluster-indicator-glow" aria-hidden="true"></span>
                  </div>
                  <div class="cluster-content">
                    <span class="cluster-label">{cluster.label}</span>
                    {cluster.description && (
                      <span class="cluster-desc">{cluster.description}</span>
                    )}
                  </div>
                  <div class="cluster-arrow-wrapper">
                    <svg
                      class="cluster-arrow"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      aria-hidden="true"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                  </div>
                </a>
              ))}
            </div>

            <!-- Featured Articles -->
            {pillar.articles.length > 0 && (
              <div class="pillar-articles">
                <div class="articles-header">
                  <svg class="articles-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d={icons.sparkle} />
                  </svg>
                  <span class="articles-heading">أحدث المقالات</span>
                </div>
                <div class="articles-list">
                  {pillar.articles.map((article) => (
                    <a
                      href={`/${article.pillar}/${article.cluster}/${article.slug}`}
                      class="article-link"
                      role="menuitem"
                      tabindex="-1"
                      data-cluster-link
                    >
                      <span class="article-bullet" aria-hidden="true"></span>
                      <span class="article-title">{article.title}</span>
                    </a>
                  ))}
                </div>
              </div>
            )}

            <!-- CTA Button -->
            <a href={pillar.href} class="pillar-cta">
              <span class="pillar-cta-text">استكشف {pillar.label}</span>
              <div class="pillar-cta-icon">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </div>
              <div class="pillar-cta-shimmer" aria-hidden="true"></div>
            </a>
          </div>
        ))}
      </div>

      <!-- Footer Bar -->
      <div class="mega-menu-footer">
        <div class="footer-content">
          <div class="footer-trust">
            <div class="trust-badge">
              <svg class="trust-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.746 3.746 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" />
              </svg>
              <span>محتوى تعليمي موثوق</span>
            </div>
            <div class="trust-divider"></div>
            <div class="trust-badge">
              <svg class="trust-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
              </svg>
              <span>4 محاور تعليمية</span>
            </div>
          </div>

          <div class="footer-links">
            <a href="/about" class="footer-link">
              <span>من نحن</span>
            </a>
            <span class="footer-link-divider"></span>
            <a href="/faq" class="footer-link footer-link-teal">
              <span>الأسئلة الشائعة</span>
              <svg class="footer-link-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ═══════════════════════════════════════════════════════════════════════════════
     MEGA MENU PANEL - 4 Pillars Layout
     ═══════════════════════════════════════════════════════════════════════════════ */

  .mega-menu-panel {
    position: absolute;
    top: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%) translateY(-12px) scale(0.98);
    width: calc(100% - 2rem);
    max-width: 1400px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1),
      visibility 0.3s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: none;
    will-change: transform, opacity;
  }

  .mega-menu-panel[hidden] {
    display: block;
  }

  .mega-menu-panel.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0) scale(1);
    pointer-events: auto;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     BACKDROP - Glassmorphism
     ═══════════════════════════════════════════════════════════════════════════════ */

  .mega-menu-backdrop {
    position: absolute;
    inset: 0;
    overflow: hidden;
    border-radius: 1rem;
  }

  .backdrop-glass {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(250, 251, 252, 0.97) 100%);
    backdrop-filter: blur(24px) saturate(200%);
    -webkit-backdrop-filter: blur(24px) saturate(200%);
    border: 1px solid rgba(226, 232, 240, 0.7);
    border-radius: 1rem;
    box-shadow:
      0 25px 80px rgba(15, 23, 42, 0.12),
      0 12px 40px rgba(15, 23, 42, 0.08),
      0 4px 16px rgba(15, 23, 42, 0.05),
      inset 0 1px 0 rgba(255, 255, 255, 0.9);
  }

  .backdrop-pattern {
    position: absolute;
    inset: 0;
    background-image: radial-gradient(circle at 1px 1px, rgba(16, 41, 65, 0.03) 1px, transparent 0);
    background-size: 24px 24px;
    border-radius: 1rem;
    opacity: 0;
    transition: opacity 0.5s ease 0.1s;
  }

  .mega-menu-panel.is-open .backdrop-pattern {
    opacity: 1;
  }

  .backdrop-glow {
    position: absolute;
    width: 200px;
    height: 150px;
    border-radius: 50%;
    filter: blur(50px);
    opacity: 0;
    transition: opacity 0.6s ease 0.15s;
    pointer-events: none;
  }

  .mega-menu-panel.is-open .backdrop-glow {
    opacity: 1;
  }

  .glow-basics {
    top: -20px;
    right: 10%;
    background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
  }

  .glow-indicators {
    top: 40%;
    right: 35%;
    background: radial-gradient(circle, rgba(249, 115, 22, 0.08) 0%, transparent 70%);
  }

  .glow-tools {
    top: 30%;
    left: 35%;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
  }

  .glow-tactics {
    top: -20px;
    left: 10%;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.08) 0%, transparent 70%);
  }

  .backdrop-teal-line {
    position: absolute;
    top: 0;
    left: 1rem;
    right: 1rem;
    height: 3px;
    background: linear-gradient(90deg, transparent 0%, rgba(8, 145, 178, 0.2) 15%, rgba(8, 145, 178, 0.5) 35%, #0891B2 50%, rgba(8, 145, 178, 0.5) 65%, rgba(8, 145, 178, 0.2) 85%, transparent 100%);
    border-radius: 0 0 2px 2px;
    transform: scaleX(0);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.1s;
  }

  .mega-menu-panel.is-open .backdrop-teal-line {
    transform: scaleX(1);
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     CONTENT CONTAINER
     ═══════════════════════════════════════════════════════════════════════════════ */

  .mega-menu-content {
    position: relative;
    z-index: 1;
    padding: 1.75rem 0 1.25rem;
    border-radius: 1rem;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     4-COLUMN PILLAR GRID
     ═══════════════════════════════════════════════════════════════════════════════ */

  .mega-menu-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     PILLAR COLUMN
     ═══════════════════════════════════════════════════════════════════════════════ */

  .pillar-column {
    display: flex;
    flex-direction: column;
    opacity: 0;
    transform: translateY(16px);
    animation: pillarReveal 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    animation-delay: var(--pillar-delay, 0ms);
    animation-play-state: paused;
  }

  .mega-menu-panel.is-open .pillar-column {
    animation-play-state: running;
  }

  @keyframes pillarReveal {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     PILLAR HEADER
     ═══════════════════════════════════════════════════════════════════════════════ */

  .pillar-header {
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(255, 255, 255, 0.6) 100%);
    border-radius: 1rem;
    margin-bottom: 0.75rem;
    border: 1px solid rgba(226, 232, 240, 0.6);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .pillar-header:hover {
    background: linear-gradient(135deg, rgba(248, 250, 252, 1) 0%, rgba(255, 255, 255, 0.8) 100%);
    border-color: rgba(226, 232, 240, 0.8);
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.04);
  }

  .pillar-accent-bar {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--pillar-gradient-from) 0%, var(--pillar-gradient-to) 100%);
    border-radius: 0 1rem 1rem 0;
  }

  .pillar-icon-container {
    position: relative;
    flex-shrink: 0;
  }

  .pillar-icon-glow {
    position: absolute;
    inset: -6px;
    background: var(--pillar-glow);
    border-radius: 50%;
    filter: blur(10px);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .pillar-header:hover .pillar-icon-glow {
    opacity: 1;
  }

  .pillar-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.75rem;
    height: 2.75rem;
    background: linear-gradient(135deg, color-mix(in srgb, var(--pillar-color) 10%, white) 0%, color-mix(in srgb, var(--pillar-color) 5%, white) 100%);
    border-radius: 0.75rem;
    border: 1px solid color-mix(in srgb, var(--pillar-color) 15%, transparent);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .pillar-header:hover .pillar-icon-wrapper {
    transform: scale(1.05);
    box-shadow: 0 4px 16px var(--pillar-glow);
  }

  .pillar-icon {
    width: 1.375rem;
    height: 1.375rem;
    color: var(--pillar-color);
    transition: transform 0.3s ease;
  }

  .pillar-header:hover .pillar-icon {
    transform: scale(1.1);
  }

  .pillar-header-content {
    flex: 1;
    min-width: 0;
  }

  .pillar-title-group {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .pillar-title {
    font-family: var(--font-heading, 'Noto Kufi Arabic', sans-serif);
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--pillar-color);
    letter-spacing: -0.01em;
    line-height: 1.3;
  }

  .pillar-title-en {
    font-size: 0.625rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .pillar-description {
    font-size: 0.8125rem;
    color: #64748b;
    line-height: 1.5;
    margin: 0;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     CLUSTER LINKS
     ═══════════════════════════════════════════════════════════════════════════════ */

  .pillar-clusters {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    flex: 1;
  }

  .cluster-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    border-radius: 0.625rem;
    text-decoration: none;
    opacity: 0;
    transform: translateX(12px);
    animation: clusterReveal 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    animation-delay: var(--cluster-delay, 0ms);
    animation-play-state: paused;
    transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .mega-menu-panel.is-open .cluster-link {
    animation-play-state: running;
  }

  @keyframes clusterReveal {
    from { opacity: 0; transform: translateX(12px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .cluster-link:hover {
    background: linear-gradient(90deg, color-mix(in srgb, var(--pillar-color) 6%, white) 0%, color-mix(in srgb, var(--pillar-color) 3%, white) 100%);
    transform: translateX(-4px);
  }

  .cluster-link:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px white, 0 0 0 4px var(--pillar-color);
    background: color-mix(in srgb, var(--pillar-color) 5%, white);
  }

  .cluster-indicator-wrapper {
    position: relative;
    flex-shrink: 0;
  }

  .cluster-indicator {
    display: block;
    width: 6px;
    height: 6px;
    background: linear-gradient(135deg, var(--pillar-gradient-from) 0%, var(--pillar-gradient-to) 100%);
    border-radius: 50%;
    opacity: 0.5;
    transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .cluster-indicator-glow {
    position: absolute;
    inset: -3px;
    background: var(--pillar-color);
    border-radius: 50%;
    filter: blur(4px);
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .cluster-link:hover .cluster-indicator {
    opacity: 1;
    transform: scale(1.25);
  }

  .cluster-link:hover .cluster-indicator-glow {
    opacity: 0.3;
  }

  .cluster-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.0625rem;
  }

  .cluster-label {
    display: block;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #1e293b;
    transition: color 0.2s ease;
  }

  .cluster-link:hover .cluster-label {
    color: #0f172a;
  }

  .cluster-desc {
    display: block;
    font-size: 0.6875rem;
    color: #94a3b8;
    line-height: 1.4;
  }

  .cluster-link:hover .cluster-desc {
    color: #64748b;
  }

  .cluster-arrow-wrapper {
    flex-shrink: 0;
    opacity: 0;
    transform: translateX(8px);
    transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .cluster-link:hover .cluster-arrow-wrapper {
    opacity: 1;
    transform: translateX(0);
  }

  .cluster-arrow {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--pillar-color);
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     FEATURED ARTICLES
     ═══════════════════════════════════════════════════════════════════════════════ */

  .pillar-articles {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(226, 232, 240, 0.8);
  }

  .articles-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-bottom: 0.5rem;
    padding-right: 0.25rem;
  }

  .articles-icon {
    width: 0.875rem;
    height: 0.875rem;
    color: #0891B2;
  }

  .articles-heading {
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--pillar-color);
  }

  .articles-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .article-link {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.5rem 0.625rem;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .article-link:hover {
    background: rgba(248, 250, 252, 0.8);
    transform: translateX(-2px);
  }

  .article-link:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #0891B2;
    background: rgba(248, 250, 252, 0.8);
  }

  .article-bullet {
    flex-shrink: 0;
    width: 4px;
    height: 4px;
    margin-top: 0.375rem;
    background: #0891B2;
    border-radius: 50%;
    opacity: 0.6;
    transition: all 0.2s ease;
  }

  .article-link:hover .article-bullet {
    opacity: 1;
    transform: scale(1.3);
  }

  .article-title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    font-size: 0.6875rem;
    font-weight: 500;
    color: #475569;
    line-height: 1.5;
    transition: color 0.2s ease;
  }

  .article-link:hover .article-title {
    color: #1e293b;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     CTA BUTTON
     ═══════════════════════════════════════════════════════════════════════════════ */

  .pillar-cta {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    margin-top: 0.75rem;
    border-radius: 0.625rem;
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    color: var(--pillar-color);
    background: linear-gradient(135deg, color-mix(in srgb, var(--pillar-color) 8%, white) 0%, color-mix(in srgb, var(--pillar-color) 4%, white) 100%);
    border: 1px solid color-mix(in srgb, var(--pillar-color) 18%, transparent);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .pillar-cta:hover {
    background: linear-gradient(135deg, color-mix(in srgb, var(--pillar-color) 12%, white) 0%, color-mix(in srgb, var(--pillar-color) 8%, white) 100%);
    border-color: color-mix(in srgb, var(--pillar-color) 30%, transparent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px var(--pillar-glow);
  }

  .pillar-cta:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px white, 0 0 0 4px var(--pillar-color), 0 8px 24px var(--pillar-glow);
  }

  .pillar-cta-text {
    position: relative;
    z-index: 1;
  }

  .pillar-cta-icon {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .pillar-cta-icon svg {
    width: 0.875rem;
    height: 0.875rem;
  }

  .pillar-cta:hover .pillar-cta-icon {
    transform: translateX(-4px);
  }

  .pillar-cta-shimmer {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(8, 145, 178, 0.1) 50%, transparent 100%);
    transition: left 0.5s ease;
  }

  .pillar-cta:hover .pillar-cta-shimmer {
    left: 100%;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     FOOTER BAR
     ═══════════════════════════════════════════════════════════════════════════════ */

  .mega-menu-footer {
    border-top: 1px solid rgba(226, 232, 240, 0.7);
    padding-top: 1.25rem;
  }

  .footer-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
  }

  .footer-trust {
    display: flex;
    align-items: center;
    gap: 1.25rem;
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .trust-icon {
    width: 1.125rem;
    height: 1.125rem;
    color: #0891B2;
    opacity: 0.9;
  }

  .trust-badge span {
    font-size: 0.75rem;
    font-weight: 500;
    color: #64748b;
  }

  .trust-divider {
    width: 1px;
    height: 1rem;
    background: linear-gradient(180deg, transparent 0%, #e2e8f0 50%, transparent 100%);
  }

  .footer-links {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .footer-link {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.625rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #475569;
    text-decoration: none;
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .footer-link:hover {
    color: #1e293b;
    background: rgba(248, 250, 252, 0.8);
  }

  .footer-link:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #0891B2;
  }

  .footer-link-teal {
    color: #0891B2;
    background: rgba(8, 145, 178, 0.08);
    border: 1px solid rgba(8, 145, 178, 0.15);
  }

  .footer-link-teal:hover {
    color: #0E7490;
    background: rgba(8, 145, 178, 0.12);
    border-color: rgba(8, 145, 178, 0.25);
  }

  .footer-link-icon {
    width: 0.875rem;
    height: 0.875rem;
    transition: transform 0.2s ease;
  }

  .footer-link-gold:hover .footer-link-icon {
    transform: translateX(-3px);
  }

  .footer-link-divider {
    width: 1px;
    height: 0.875rem;
    background: #e2e8f0;
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     RESPONSIVE - Hide on mobile
     ═══════════════════════════════════════════════════════════════════════════════ */

  @media (max-width: 1023px) {
    .mega-menu-panel {
      display: none !important;
    }
  }

  /* Large screens */
  @media (min-width: 1280px) {
    .mega-menu-panel {
      max-width: 1320px;
    }

    .mega-menu-grid {
      gap: 2rem;
    }
  }

  /* Extra large screens */
  @media (min-width: 1536px) {
    .mega-menu-panel {
      max-width: 1440px;
    }

    .mega-menu-grid {
      gap: 2.5rem;
    }
  }

  /* ═══════════════════════════════════════════════════════════════════════════════
     REDUCED MOTION
     ═══════════════════════════════════════════════════════════════════════════════ */

  @media (prefers-reduced-motion: reduce) {
    .mega-menu-panel {
      transition: opacity 0.15s ease;
      transform: translateX(-50%);
    }

    .mega-menu-panel.is-open {
      transform: translateX(-50%);
    }

    .pillar-column,
    .cluster-link {
      animation: none;
      opacity: 1;
      transform: none;
    }

    .backdrop-gold-line {
      transition: none;
      transform: scaleX(1);
    }

    .backdrop-pattern,
    .backdrop-glow {
      transition: none;
      opacity: 1;
    }

    .cluster-link:hover,
    .article-link:hover,
    .pillar-cta:hover {
      transform: none;
    }

    .pillar-cta-shimmer {
      display: none;
    }
  }
</style>

<script>
  // MegaMenu Keyboard Navigation
  document.addEventListener('DOMContentLoaded', () => {
    const megaMenu = document.querySelector('[data-mega-menu-panel]') as HTMLElement;
    if (!megaMenu) return;

    const clusterLinks = megaMenu.querySelectorAll('[data-cluster-link]');
    const pillarColumns = megaMenu.querySelectorAll('[data-pillar-column]');

    // Keyboard navigation within mega menu
    clusterLinks.forEach((link) => {
      link.addEventListener('keydown', (e: Event) => {
        const keyEvent = e as KeyboardEvent;
        const currentColumn = (link as HTMLElement).closest('[data-pillar-column]');
        const allLinksInColumn = currentColumn?.querySelectorAll('[data-cluster-link]');

        if (!allLinksInColumn) return;

        const currentIndexInColumn = Array.from(allLinksInColumn).indexOf(link);

        switch (keyEvent.key) {
          case 'ArrowDown':
            keyEvent.preventDefault();
            const nextLink = allLinksInColumn[currentIndexInColumn + 1] || allLinksInColumn[0];
            (nextLink as HTMLElement).focus();
            break;

          case 'ArrowUp':
            keyEvent.preventDefault();
            const prevLink = allLinksInColumn[currentIndexInColumn - 1] || allLinksInColumn[allLinksInColumn.length - 1];
            (prevLink as HTMLElement).focus();
            break;

          case 'ArrowRight': // In RTL, this moves to the previous column
            keyEvent.preventDefault();
            navigateToColumn(-1, currentColumn, currentIndexInColumn);
            break;

          case 'ArrowLeft': // In RTL, this moves to the next column
            keyEvent.preventDefault();
            navigateToColumn(1, currentColumn, currentIndexInColumn);
            break;

          case 'Home':
            keyEvent.preventDefault();
            (allLinksInColumn[0] as HTMLElement).focus();
            break;

          case 'End':
            keyEvent.preventDefault();
            (allLinksInColumn[allLinksInColumn.length - 1] as HTMLElement).focus();
            break;
        }
      });
    });

    function navigateToColumn(direction: number, currentColumn: Element | null, currentIndex: number) {
      if (!currentColumn) return;

      const columns = Array.from(pillarColumns);
      const currentColumnIndex = columns.indexOf(currentColumn);
      const targetColumn = columns[currentColumnIndex + direction];

      if (targetColumn) {
        const linksInTargetColumn = targetColumn.querySelectorAll('[data-cluster-link]');
        const targetIndex = Math.min(currentIndex, linksInTargetColumn.length - 1);
        (linksInTargetColumn[targetIndex] as HTMLElement)?.focus();
      }
    }

    // GPU acceleration optimization
    pillarColumns.forEach((column) => {
      column.addEventListener('mouseenter', () => {
        (column as HTMLElement).style.willChange = 'transform';
      });

      column.addEventListener('mouseleave', () => {
        setTimeout(() => {
          (column as HTMLElement).style.willChange = '';
        }, 300);
      });
    });
  });
</script>
