---
/**
 * Modal.astro
 * Premium modal dialog component for CHARTSPOINT fintech platform
 *
 * Features:
 * - Multiple size variants: sm, md, lg, xl, full
 * - Backdrop blur and overlay
 * - Focus trap and keyboard navigation
 * - Close on escape key
 * - Close on backdrop click (optional)
 * - Header, body, footer slots
 * - Scroll lock on body when open
 * - Accessible with ARIA attributes
 * - Smooth scale/fade animation
 * - Optimized for users aged 40-70
 */

export interface Props {
  /** Unique modal ID for triggering */
  id: string;
  /** Modal title (displayed in header) */
  title?: string;
  /** Modal size variant */
  size?: 'sm' | 'md' | 'lg' | 'xl' | 'full';
  /** Show close button in header */
  showCloseButton?: boolean;
  /** Close when clicking backdrop */
  closeOnBackdrop?: boolean;
  /** Close when pressing Escape key */
  closeOnEscape?: boolean;
  /** Initially open (for server-rendered state) */
  open?: boolean;
  /** Additional CSS classes for dialog */
  class?: string;
}

const {
  id,
  title,
  size = 'md',
  showCloseButton = true,
  closeOnBackdrop = true,
  closeOnEscape = true,
  open = false,
  class: className = '',
} = Astro.props;

// Size classes mapping
const sizeClasses: Record<string, string> = {
  sm: 'max-w-sm',
  md: 'max-w-lg',
  lg: 'max-w-2xl',
  xl: 'max-w-4xl',
  full: 'max-w-[95vw] max-h-[95vh]',
};

// Check if slots are provided
const hasHeader = Astro.slots.has('header') || title;
const hasFooter = Astro.slots.has('footer');
---

<!-- Modal Overlay -->
<div
  id={id}
  class="modal"
  data-modal
  data-close-on-backdrop={closeOnBackdrop ? 'true' : 'false'}
  data-close-on-escape={closeOnEscape ? 'true' : 'false'}
  data-open={open ? 'true' : undefined}
  role="dialog"
  aria-modal="true"
  aria-labelledby={title ? `${id}-title` : undefined}
  aria-hidden={!open}
>
  <!-- Backdrop -->
  <div class="modal__backdrop" data-modal-backdrop aria-hidden="true"></div>

  <!-- Dialog -->
  <div class={`modal__dialog ${sizeClasses[size]} ${className}`} data-modal-dialog>
    {/* Header */}
    {hasHeader && (
      <header class="modal__header">
        <slot name="header">
          {title && (
            <h2 id={`${id}-title`} class="modal__title">
              {title}
            </h2>
          )}
        </slot>

        {showCloseButton && (
          <button
            type="button"
            class="modal__close"
            data-modal-close
            aria-label="إغلاق النافذة"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        )}
      </header>
    )}

    {/* Body */}
    <div class="modal__body">
      <slot />
    </div>

    {/* Footer */}
    {hasFooter && (
      <footer class="modal__footer">
        <slot name="footer" />
      </footer>
    )}
  </div>
</div>

<style>
  /* ═══════════════════════════════════════════════════════════════════════════
     MODAL OVERLAY
     ═══════════════════════════════════════════════════════════════════════════ */

  .modal {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal, 500);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;

    /* Hidden state */
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0s linear 0.3s;
  }

  .modal[data-open="true"] {
    opacity: 1;
    visibility: visible;
    transition:
      opacity 0.3s ease,
      visibility 0s linear 0s;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     BACKDROP
     ═══════════════════════════════════════════════════════════════════════════ */

  .modal__backdrop {
    position: absolute;
    inset: 0;
    background-color: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     DIALOG
     ═══════════════════════════════════════════════════════════════════════════ */

  .modal__dialog {
    position: relative;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    background-color: #FFFFFF;
    border-radius: 1rem;
    box-shadow: 0 25px 80px rgba(15, 23, 42, 0.25);
    overflow: hidden;

    /* Animation */
    transform: scale(0.95);
    transition: transform 0.3s ease;
  }

  .modal[data-open="true"] .modal__dialog {
    transform: scale(1);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     HEADER
     ═══════════════════════════════════════════════════════════════════════════ */

  .modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #F1F5F9;
    flex-shrink: 0;
  }

  .modal__title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 700;
    color: #102941;
    margin: 0;
    line-height: 1.3;
  }

  .modal__close {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #94A3B8;
    background-color: transparent;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition:
      color 0.2s ease,
      background-color 0.2s ease;
  }

  .modal__close:hover {
    color: #475569;
    background-color: #F1F5F9;
  }

  .modal__close:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px rgba(213, 160, 53, 0.4);
  }

  .modal__close svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     BODY
     ═══════════════════════════════════════════════════════════════════════════ */

  .modal__body {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    font-size: 1.125rem;
    line-height: 1.7;
    color: #334155;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     FOOTER
     ═══════════════════════════════════════════════════════════════════════════ */

  .modal__footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-top: 1px solid #F1F5F9;
    background-color: #F8FAFC;
    flex-shrink: 0;
  }

  /* RTL: Reverse footer button order */
  .modal__footer {
    flex-direction: row-reverse;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     RESPONSIVE
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (max-width: 640px) {
    .modal {
      padding: 0.5rem;
    }

    .modal__header {
      padding: 1.25rem 1.5rem;
    }

    .modal__body {
      padding: 1.5rem;
    }

    .modal__footer {
      padding: 1.25rem 1.5rem;
      flex-direction: column;
      gap: 0.75rem;
    }

    .modal__footer > :global(*) {
      width: 100%;
    }
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     REDUCED MOTION
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (prefers-reduced-motion: reduce) {
    .modal,
    .modal__dialog {
      transition: none;
    }

    .modal__dialog {
      transform: none;
    }
  }
</style>

<script>
  /**
   * Modal Controller
   * Handles opening, closing, focus trap, and keyboard navigation
   */

  interface ModalElement extends HTMLElement {
    _controller?: ModalController;
  }

  class ModalController {
    private modal: ModalElement;
    private dialog: HTMLElement;
    private backdrop: HTMLElement;
    private closeOnBackdrop: boolean;
    private closeOnEscape: boolean;
    private previousActiveElement: HTMLElement | null = null;
    private focusableElements: HTMLElement[] = [];

    constructor(modal: ModalElement) {
      this.modal = modal;
      this.dialog = modal.querySelector('[data-modal-dialog]') as HTMLElement;
      this.backdrop = modal.querySelector('[data-modal-backdrop]') as HTMLElement;
      this.closeOnBackdrop = modal.dataset.closeOnBackdrop === 'true';
      this.closeOnEscape = modal.dataset.closeOnEscape === 'true';

      this.init();
    }

    private init(): void {
      // Close button handlers
      const closeButtons = this.modal.querySelectorAll('[data-modal-close]');
      closeButtons.forEach((btn) => {
        btn.addEventListener('click', () => this.close());
      });

      // Backdrop click
      if (this.closeOnBackdrop) {
        this.backdrop.addEventListener('click', () => this.close());
      }

      // Escape key
      if (this.closeOnEscape) {
        this.modal.addEventListener('keydown', (e: KeyboardEvent) => {
          if (e.key === 'Escape') {
            e.preventDefault();
            this.close();
          }
        });
      }

      // Focus trap
      this.modal.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Tab') {
          this.handleTab(e);
        }
      });

      // Check if initially open
      if (this.modal.dataset.open === 'true') {
        this.open();
      }
    }

    open(): void {
      // Store previous focus
      this.previousActiveElement = document.activeElement as HTMLElement;

      // Show modal
      this.modal.dataset.open = 'true';
      this.modal.setAttribute('aria-hidden', 'false');

      // Lock body scroll
      document.body.style.overflow = 'hidden';

      // Update focusable elements
      this.updateFocusableElements();

      // Focus first focusable element
      requestAnimationFrame(() => {
        if (this.focusableElements.length > 0) {
          this.focusableElements[0].focus();
        }
      });

      // Dispatch event
      this.modal.dispatchEvent(new CustomEvent('modal:open', { bubbles: true }));
    }

    close(): void {
      // Hide modal
      this.modal.dataset.open = 'false';
      this.modal.setAttribute('aria-hidden', 'true');

      // Unlock body scroll
      document.body.style.overflow = '';

      // Restore focus
      if (this.previousActiveElement) {
        this.previousActiveElement.focus();
      }

      // Dispatch event
      this.modal.dispatchEvent(new CustomEvent('modal:close', { bubbles: true }));
    }

    private updateFocusableElements(): void {
      const focusableSelectors = [
        'button:not([disabled])',
        'a[href]',
        'input:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        '[tabindex]:not([tabindex="-1"])',
      ];

      this.focusableElements = Array.from(
        this.dialog.querySelectorAll(focusableSelectors.join(', '))
      ) as HTMLElement[];
    }

    private handleTab(e: KeyboardEvent): void {
      if (this.focusableElements.length === 0) return;

      const firstElement = this.focusableElements[0];
      const lastElement = this.focusableElements[this.focusableElements.length - 1];

      if (e.shiftKey) {
        // Shift + Tab
        if (document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        }
      } else {
        // Tab
        if (document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    }
  }

  // Initialize all modals
  function initModals(): void {
    const modals = document.querySelectorAll<ModalElement>('[data-modal]');
    modals.forEach((modal) => {
      if (!modal._controller) {
        modal._controller = new ModalController(modal);
      }
    });
  }

  // Global modal functions
  function openModal(id: string): void {
    const modal = document.getElementById(id) as ModalElement;
    modal?._controller?.open();
  }

  function closeModal(id: string): void {
    const modal = document.getElementById(id) as ModalElement;
    modal?._controller?.close();
  }

  // Expose globally
  (window as any).openModal = openModal;
  (window as any).closeModal = closeModal;

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModals);
  } else {
    initModals();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initModals);

  // Trigger buttons
  document.addEventListener('click', (e) => {
    const trigger = (e.target as HTMLElement).closest('[data-modal-trigger]') as HTMLElement;
    if (trigger) {
      const modalId = trigger.dataset.modalTrigger;
      if (modalId) openModal(modalId);
    }
  });
</script>
