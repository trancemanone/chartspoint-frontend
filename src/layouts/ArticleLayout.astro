---
/**
 * ArticleLayout.astro
 *
 * Sophisticated article layout for ITQQAN financial education content.
 * Designed for optimal readability and trust-building.
 *
 * Features:
 * - Breadcrumbs navigation
 * - Sticky table of contents sidebar
 * - Premium article typography
 * - Author bio card with E-E-A-T signals
 * - Trust badges for financial content
 * - FAQ accordion section
 * - Related articles grid
 * - Mobile-optimized reading experience
 */

import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '@components/navigation/Breadcrumbs.astro';
import TableOfContents from '@components/content/TableOfContents.astro';
import FAQAccordion from '@components/content/FAQAccordion.astro';
import AuthorBio from '@components/author/AuthorBio.astro';
import RelatedArticles from '@components/content/RelatedArticles.astro';
import type { Article, TOCItem } from '@lib/types';
import { PILLAR_NAMES_AR, CLUSTER_NAMES_AR } from '@lib/content-structure';

export interface Props {
  article: Article;
}

const { article } = Astro.props;

// Generate breadcrumbs
const breadcrumbs = [
  { label: 'الرئيسية', href: '/' },
  { label: PILLAR_NAMES_AR[article.pillar], href: `/${article.pillar}` },
  { label: CLUSTER_NAMES_AR[article.cluster] || article.cluster, href: `/${article.pillar}/${article.cluster}` },
  { label: article.title, href: '#', current: true },
];

// Extract TOC from content - handles WordPress HTML with nested tags
function extractTOC(content: string): TOCItem[] {
  const toc: TOCItem[] = [];
  // Match h2 and h3 tags, capturing the full inner content (may include nested tags)
  const headingRegex = /<h([23])([^>]*)>([\s\S]*?)<\/h[23]>/gi;
  let match;
  let counter = 0;

  while ((match = headingRegex.exec(content)) !== null) {
    // Strip HTML tags to get plain text
    const plainText = match[3].replace(/<[^>]*>/g, '').trim();
    if (plainText) {
      // Generate slug-based ID from Arabic text
      const slug = `section-${counter}`;
      toc.push({
        id: slug,
        text: plainText,
        level: parseInt(match[1]) as 2 | 3,
      });
      counter++;
    }
  }

  return toc;
}

// Process content to add IDs to headings for TOC linking
function processContent(content: string): string {
  let counter = 0;
  return content.replace(/<h([23])([^>]*)>([\s\S]*?)<\/h[23]>/gi, (match, level, attrs, innerHtml) => {
    const plainText = innerHtml.replace(/<[^>]*>/g, '').trim();
    if (!plainText) return match; // Skip empty headings

    const slug = `section-${counter}`;
    counter++;

    // Check if ID already exists in attrs
    if (attrs.includes('id=')) {
      return match; // Keep existing ID
    }

    return `<h${level}${attrs} id="${slug}">${innerHtml}</h${level}>`;
  });
}

const tocItems = extractTOC(article.content);
const processedContent = processContent(article.content);

// Pillar color classes for visual hierarchy
const pillarColorMap: Record<string, { border: string; bg: string; text: string; badge: string }> = {
  basics: {
    border: 'border-blue-500',
    bg: 'bg-blue-50',
    text: 'text-blue-600',
    badge: 'bg-blue-100 text-blue-800',
  },
  indicators: {
    border: 'border-orange-500',
    bg: 'bg-orange-50',
    text: 'text-orange-600',
    badge: 'bg-orange-100 text-orange-800',
  },
  tools: {
    border: 'border-green-500',
    bg: 'bg-green-50',
    text: 'text-green-600',
    badge: 'bg-green-100 text-green-800',
  },
  tactics: {
    border: 'border-purple-500',
    bg: 'bg-purple-50',
    text: 'text-purple-600',
    badge: 'bg-purple-100 text-purple-800',
  },
  // Legacy support
  learn: {
    border: 'border-learn-500',
    bg: 'bg-learn-50',
    text: 'text-learn-600',
    badge: 'badge-learn',
  },
  accounts: {
    border: 'border-accounts-500',
    bg: 'bg-accounts-50',
    text: 'text-accounts-600',
    badge: 'badge-accounts',
  },
  trust: {
    border: 'border-trust-500',
    bg: 'bg-trust-50',
    text: 'text-trust-600',
    badge: 'badge-trust',
  },
};
const pillarColors = pillarColorMap[article.pillar] || pillarColorMap.basics;

// Expertise level styling
const expertiseLevels = {
  beginner: { label: 'مبتدئ', class: 'bg-success-100 text-success-700' },
  intermediate: { label: 'متوسط', class: 'bg-warning-100 text-warning-700' },
  advanced: { label: 'متقدم', class: 'bg-error-100 text-error-700' },
};

const expertiseInfo = expertiseLevels[article.expertiseLevel] || expertiseLevels.beginner;

// Format dates for Arabic locale
const publishDate = new Date(article.publishDate).toLocaleDateString('ar-SA', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const modifiedDate = new Date(article.modifiedDate).toLocaleDateString('ar-SA', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Article schema for structured data
const articleSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": article.title,
  "description": article.seo.description,
  "image": article.featuredImage?.url,
  "author": {
    "@type": "Person",
    "name": article.author.name,
    "description": article.author.bio,
  },
  "publisher": {
    "@type": "Organization",
    "name": "تشارتس بوينت",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chartspoint.com/images/logo.svg"
    }
  },
  "datePublished": article.publishDate,
  "dateModified": article.modifiedDate,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": article.seo.canonical,
  },
  "inLanguage": "ar",
  "wordCount": article.wordCount,
  "articleSection": PILLAR_NAMES_AR[article.pillar],
});

// Generate author URL for linking
const authorUrl = article.author.slug ? `/author/${article.author.slug}` : null;

// FAQ Schema for SEO
const faqSchema = article.faqs.length > 0 ? JSON.stringify({
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": article.faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
}) : null;

// Breadcrumb schema
const breadcrumbSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": item.label,
    "item": item.current ? undefined : `https://chartspoint.com${item.href}`
  }))
});
---

<BaseLayout
  title={article.seo.title}
  description={article.seo.description}
  canonical={article.seo.canonical}
  ogImage={article.seo.ogImage}
  schema={articleSchema}
  pillar={article.pillar}
>
  <article class="article-page" itemscope itemtype="https://schema.org/Article">
    <!-- Breadcrumbs Section -->
    <div class="bg-slate-50 border-b border-slate-200">
      <div class="container mx-auto px-4 lg:px-8 py-4">
        <Breadcrumbs items={breadcrumbs} />
      </div>
    </div>

    <!-- Article Header -->
    <header class="bg-white border-b border-slate-100">
      <div class="container mx-auto px-4 lg:px-8 py-8 lg:py-12">
        <div class="max-w-4xl">
          <!-- How We Produce Content - Above H1 -->
          <div class="content-production-banner mb-6 p-4 rounded-xl bg-gradient-to-l from-teal-50 to-slate-50 border border-teal-100">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-heading font-bold text-navy-800 text-sm mb-1">كيف ننتج المحتوى</h4>
                <p class="text-xs text-slate-600 leading-relaxed">
                  يكتبه خبراء في التحليل الفني ويراجعه فريق تشارتس بوينت من مصادر موثوقة ومحدثة
                </p>
              </div>
            </div>
          </div>

          <!-- Pillar Badge -->
          <div class="mb-4">
            <span class={`badge ${pillarColors.badge}`}>
              {PILLAR_NAMES_AR[article.pillar]}
            </span>
          </div>

          <!-- Article Title -->
          <h1
            class="text-h1-mobile md:text-h1-desktop font-heading font-extrabold text-navy-900 mb-6 text-balance"
            itemprop="headline"
          >
            {article.title}
          </h1>

          <!-- Article Meta Info -->
          <div class="flex flex-wrap items-center gap-4 lg:gap-6 text-slate-600 mb-6">
            <!-- Author with Link -->
            <div class="flex items-center gap-3">
              {article.author.avatar && (
                authorUrl ? (
                  <a href={authorUrl} class="block rounded-full hover:ring-2 hover:ring-teal-300 transition-all">
                    <img
                      src={article.author.avatar}
                      alt={article.author.name}
                      class="w-10 h-10 rounded-full object-cover border-2 border-slate-200"
                    />
                  </a>
                ) : (
                  <img
                    src={article.author.avatar}
                    alt={article.author.name}
                    class="w-10 h-10 rounded-full object-cover border-2 border-slate-200"
                  />
                )
              )}
              <div class="flex flex-col">
                {authorUrl ? (
                  <a href={authorUrl} class="font-medium text-navy-800 hover:text-teal-600 transition-colors underline decoration-dotted underline-offset-2">
                    {article.author.name}
                  </a>
                ) : (
                  <span class="font-medium text-navy-800">{article.author.name}</span>
                )}
                <span class="text-sm text-slate-500">{publishDate}</span>
              </div>
            </div>

            <!-- Divider -->
            <span class="hidden sm:block w-px h-8 bg-slate-200"></span>

            <!-- Modified Date -->
            <span class="flex items-center gap-2 text-sm">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              <span>تحديث: {modifiedDate}</span>
            </span>

            <!-- Divider -->
            <span class="hidden sm:block w-px h-8 bg-slate-200"></span>

            <!-- Reading Time -->
            <span class="flex items-center gap-2">
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>{article.readingTime} دقائق للقراءة</span>
            </span>

            <!-- Expertise Level -->
            <span class={`px-3 py-1 rounded-full text-sm font-medium ${expertiseInfo.class}`}>
              {expertiseInfo.label}
            </span>
          </div>

          <!-- Featured Image -->
          {article.featuredImage && (
            <figure class={`relative rounded-2xl overflow-hidden border-4 ${pillarColors.border} shadow-card-elevated`}>
              <img
                src={article.featuredImage.url}
                alt={article.featuredImage.alt}
                width={article.featuredImage.width}
                height={article.featuredImage.height}
                class="w-full h-auto object-cover"
                loading="eager"
                itemprop="image"
              />
            </figure>
          )}
        </div>
      </div>
    </header>

    <!-- Main Content Area with Sidebar -->
    <div class="bg-surface-page">
      <div class="container mx-auto px-4 lg:px-8 py-12 lg:py-16">
        <div class="lg:grid lg:grid-cols-12 lg:gap-12">

          <!-- Table of Contents Sidebar (Desktop) -->
          <aside class="hidden lg:block lg:col-span-3">
            <div class="sticky top-24">
              <TableOfContents items={tocItems} pillar={article.pillar} />

              <!-- Contact for Update -->
              <div class="content-box-highlight mt-8">
                <h4 class="font-heading font-bold text-navy-800 mb-3 flex items-center gap-2">
                  <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                  </svg>
                  ساعدنا في تحسين المحتوى
                </h4>
                <p class="text-sm text-slate-600 mb-4">
                  لديك اقتراح أو تصحيح؟ نرحب بمشاركتك لتحسين جودة المحتوى.
                </p>
                <a
                  href="/contact"
                  class="inline-flex items-center gap-1 text-sm text-teal-600 hover:text-teal-700 font-medium"
                >
                  تواصل معنا
                  <svg class="w-4 h-4 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              </div>
            </div>
          </aside>

          <!-- Article Content Column -->
          <div class="lg:col-span-9">
            <!-- Mobile TOC (handled by TableOfContents component's built-in mobile accordion) -->
            {tocItems.length > 0 && (
              <div class="lg:hidden">
                <TableOfContents items={tocItems} pillar={article.pillar} />
              </div>
            )}

            <!-- Main Article Content -->
            <div class="content-box">
              <!-- Hidden dates for Schema.org -->
              <meta itemprop="datePublished" content={article.publishDate} />
              <meta itemprop="dateModified" content={article.modifiedDate} />

              <!-- Article Body -->
              <div
                class="article-content"
                data-pillar={article.pillar}
                itemprop="articleBody"
                set:html={processedContent}
              />

            </div>

            <!-- FAQ Section -->
            {article.faqs.length > 0 && (
              <section class="mt-12">
                <div class="content-box">
                  <h2 class="text-h2-mobile md:text-h2-desktop font-heading font-bold text-navy-900 mb-6 flex items-center gap-3">
                    <svg class="w-8 h-8 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    الأسئلة الشائعة
                  </h2>
                  <FAQAccordion faqs={article.faqs} />
                </div>
              </section>
            )}

            <!-- Related Articles -->
            {article.relatedArticles.length > 0 && (
              <section class="mt-12">
                <h2 class="text-h2-mobile md:text-h2-desktop font-heading font-bold text-navy-900 mb-8 flex items-center gap-3">
                  <svg class="w-8 h-8 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  مقالات ذات صلة
                </h2>
                <RelatedArticles articles={article.relatedArticles} />
              </section>
            )}
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Additional Schema -->
  <Fragment slot="schema">
    <script type="application/ld+json" set:html={breadcrumbSchema} />
    {faqSchema && <script type="application/ld+json" set:html={faqSchema} />}
  </Fragment>
</BaseLayout>

<style>
  /* ═══════════════════════════════════════════════════════════════════════════
     ARTICLE LAYOUT - Component-Scoped Enhancements
     Works in conjunction with global.css article-content styles
     ═══════════════════════════════════════════════════════════════════════════ */

  /* Article page specific adjustments */
  .article-page {
    --article-max-content-width: 65ch;
  }

  /* Mobile-specific article optimizations */
  @media (max-width: 768px) {
    .article-content :global(h2) {
      margin-top: 2.5rem;
      margin-bottom: 1.25rem;
    }

    .article-content :global(h3) {
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .article-content :global(table) {
      font-size: 0.9375rem;
    }

    .article-content :global(th),
    .article-content :global(td) {
      padding: 0.75rem;
    }

    /* Adjust bullet padding for mobile */
    .article-content :global(ul > li) {
      padding-right: 1.5rem;
    }

    .article-content :global(ol > li) {
      padding-right: 2.25rem;
    }
  }

  /* Print optimizations for article content */
  @media print {
    .article-content :global(h2)::after,
    .article-content :global(h3)::before {
      display: none;
    }

    .article-content :global(a) {
      box-shadow: none;
      text-decoration: underline;
    }

    .article-content :global(ul > li)::before,
    .article-content :global(ol > li)::before {
      print-color-adjust: exact;
      -webkit-print-color-adjust: exact;
    }
  }
</style>

<script>
  /**
   * Article Typography Enhancement Script
   *
   * Provides progressive enhancement for:
   * 1. H2 headings - First word underline effect
   * 2. H3 headings - Scroll-triggered accent line animation
   *
   * Fully RTL compatible and accessible
   */
  document.addEventListener('DOMContentLoaded', () => {
    const articleContent = document.querySelector('.article-content');
    if (!articleContent) return;

    // ─────────────────────────────────────────────────────────────────────────
    // H2 Enhancement: First Word Underline
    // ─────────────────────────────────────────────────────────────────────────
    const h2Elements = articleContent.querySelectorAll('h2');

    h2Elements.forEach((h2) => {
      const text = h2.textContent?.trim();
      if (!text) return;

      // Split by whitespace to get first word (works for Arabic)
      const words = text.split(/\s+/);
      if (words.length === 0) return;

      const firstWord = words[0];
      const restOfText = words.slice(1).join(' ');

      // Preserve the ID if present
      const id = h2.getAttribute('id');

      // Create enhanced HTML structure
      h2.classList.add('article-h2-enhanced');
      h2.innerHTML = `<span class="h2-first-word">${firstWord}</span>${restOfText ? ' ' + restOfText : ''}`;

      // Restore ID
      if (id) h2.setAttribute('id', id);
    });

    // ─────────────────────────────────────────────────────────────────────────
    // H3 Enhancement: Scroll-Triggered Accent Animation
    // ─────────────────────────────────────────────────────────────────────────
    const h3Elements = articleContent.querySelectorAll('h3');

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (!prefersReducedMotion && 'IntersectionObserver' in window) {
      const h3Observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('h3-visible');
              // Optional: unobserve after animation
              h3Observer.unobserve(entry.target);
            }
          });
        },
        {
          root: null,
          rootMargin: '-50px 0px -100px 0px',
          threshold: 0.1,
        }
      );

      h3Elements.forEach((h3) => {
        h3Observer.observe(h3);
      });
    } else {
      // Fallback: show all accent lines immediately
      h3Elements.forEach((h3) => {
        h3.classList.add('h3-visible');
      });
    }

    // ─────────────────────────────────────────────────────────────────────────
    // Smooth Scroll for TOC Links
    // ─────────────────────────────────────────────────────────────────────────
    const tocLinks = document.querySelectorAll('.toc-link');

    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        const href = link.getAttribute('href');
        if (!href?.startsWith('#')) return;

        const target = document.querySelector(href);
        if (!target) return;

        e.preventDefault();

        // Smooth scroll with offset for sticky header
        const headerOffset = 100;
        const elementPosition = target.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
          top: offsetPosition,
          behavior: prefersReducedMotion ? 'auto' : 'smooth',
        });

        // Update URL without scrolling
        history.pushState(null, '', href);
      });
    });
  });
</script>
